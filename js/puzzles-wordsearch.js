
(async function(){
  const { Timer, SFX } = window.AppUtil;
  const DATA = await (await fetch('data/wordsearch.json')).json();
  const $ = s=>document.querySelector(s); const $$ = s=>Array.from(document.querySelectorAll(s));
  const catSel = $('#wsCat'), gridEl = $('#wsGrid'), listEl = $('#wsList'); const hudTime = $('#wsTime'), hudScore=$('#wsScore'); const timer = new Timer(hudTime);
  Object.keys(DATA).forEach(c=> catSel.append(new Option(c,c)));
  const DIRS = [[1,0],[0,1],[1,1],[-1,0],[0,-1],[-1,-1],[1,-1],[-1,1]]; let grid=[], size=12, words=[], placed=[], selA=null, selB=null, found=0;
  function makeGrid(){ grid = Array.from({length:size}, ()=> Array(size).fill('')); }
  function canPlace(word,r,c,dr,dc){ for(let i=0;i<word.length;i++){ const rr=r+dr*i, cc=c+dc*i; if(rr<0||cc<0||rr>=size||cc>=size) return false; const ch=grid[rr][cc]; if (ch && ch!==word[i]) return false; } return true; }
  function placeWord(word){ for(let k=0;k<200;k++){ const [dr,dc]=DIRS[Math.floor(Math.random()*DIRS.length)]; const r=Math.floor(Math.random()*size), c=Math.floor(Math.random()*size); if(canPlace(word,r,c,dr,dc)){ for(let i=0;i<word.length;i++){ grid[r+dr*i][c+dc*i]=word[i]; } placed.push({word,r,c,dr,dc}); return true; } } return false; }
  function fillRandom(){ const A='ABCDEFGHIJKLMNOPQRSTUVWXYZ'; for(let r=0;r<size;r++){ for(let c=0;c<size;c++){ if(!grid[r][c]) grid[r][c]=A[Math.floor(Math.random()*A.length)]; } } }
  function render(){ gridEl.innerHTML=''; const t=document.createElement('table'); t.className='ws-grid'; for(let r=0;r<size;r++){ const tr=document.createElement('tr'); for(let c=0;c<size;c++){ const td=document.createElement('td'); td.textContent=grid[r][c]; td.dataset.r=r; td.dataset.c=c; td.addEventListener('click', onCellClick); tr.appendChild(td);} t.appendChild(tr);} gridEl.appendChild(t); listEl.innerHTML = words.map(w=>`<li data-w="${w}">${w}</li>`).join(''); }
  function resetSelection(){ $$('.ws-grid td').forEach(td=> td.classList.remove('selected')); selA=selB=null; }
  function markLine(r,c,dr,dc,len,cls){ for(let i=0;i<len;i++){ const td = document.querySelector(`.ws-grid td[data-r="${r+dr*i}"][data-c="${c+dc*i}"]`); td && td.classList.add(cls); } }
  function onCellClick(e){ const td=e.currentTarget; td.classList.add('selected'); if(!selA){ selA=td; return; } if(!selB){ selB=td; } const r1=+selA.dataset.r, c1=+selA.dataset.c, r2=+selB.dataset.r, c2=+selB.dataset.c; const dr=Math.sign(r2-r1), dc=Math.sign(c2-c1); const len=Math.max(Math.abs(r2-r1), Math.abs(c2-c1))+1; const seq=[]; for(let i=0;i<len;i++){ const rr=r1+dr*i, cc=c1+dc*i; const cell=document.querySelector(`.ws-grid td[data-r="${rr}"][data-c="${cc}"]`); if(!cell){ resetSelection(); return; } seq.push(cell.textContent);} const word=seq.join(''); const rev=seq.slice().reverse().join(''); const hit=placed.find(p=>{ const w=p.word; if(p.r===r1 && p.c===c1 && p.dr===dr && p.dc===dc && w.length===len) return true; if(p.r+(p.dr*(w.length-1))===r1 && p.c+(p.dc*(w.length-1))===c1 && p.dr===-dr && p.dc===-dc && w.length===len) return true; return false; }); if(hit && (hit.word===word || hit.word===rev)){ markLine(r1,c1,dr,dc,len,'found'); const li=document.querySelector(`.word-list li[data-w="${hit.word}"]`); if(li && !li.classList.contains('found')){ li.classList.add('found'); found++; hudScore.textContent=String(found); SFX.correct(); if(found===words.length){ timer.stop(); const bestKey=`wordsearch:${catSel.value}`; const best=JSON.parse(localStorage.getItem(bestKey)||'null'); const cur={ms: timer.elapsedMs()}; if(!best || cur.ms<best.ms){ localStorage.setItem(bestKey, JSON.stringify(cur)); } SFX.success(); } } } else { SFX.wrong(); } resetSelection(); }
  function build(){ words = [...DATA[catSel.value]]; placed=[]; found=0; hudScore.textContent='0'; size = Math.max(12, Math.min(18, Math.ceil(Math.max(...words.map(w=>w.length))*1.8))); makeGrid(); words.slice().sort((a,b)=>b.length-a.length).forEach(w=> placeWord(w)); fillRandom(); render(); timer.reset(); timer.start(); SFX.click(); }
  document.getElementById('wsNew').addEventListener('click', build); catSel.addEventListener('change', build); catSel.value = Object.keys(DATA)[0]; build();
})();
